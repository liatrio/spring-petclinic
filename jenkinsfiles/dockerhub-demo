pipeline {
    agent none
    stages {
       stage('Build') {
           agent {
               docker {
                   image 'maven:3.5.0'
               }
           }
           steps {
                   sh 'mvn clean install -DskipTests=true -B'
           }
       }
       stage('Build container') {
             agent any
             steps {
                 script {
                     sh "docker build -t liatrio/petclinic-tomcat:${env.BRANCH_NAME} ."
                     if ( ${env.BRANCH_NAME} == 'master' ) {
                         def containerVersion = getVersionFromContainer("liatrio/petclinic-tomcat:${env.BRANCH_NAME}")
                         failIfVersionExists("liatrio","petclinic-tomcat",containerVersion)
                         sh "docker build -t liatrio/petclinic-tomcat:${containerVersion} ."
                     }
                 }
             }
       }
       stage('Push to dockerhub') {
           agent any
           steps {
                script {
                    if ( ${env.BRANCH_NAME} == 'master' ) 
                        sh "docker push liatrio/petclinic-tomcat:${containerVersion}"
                    else sh "docker push  liatrio/petclinic-tomcat:${env.BRANCH_NAME}"
                }
           }
       }
   }
}
